name: Daily Email Cron Job

on:
  schedule:
    # ë§¤ì¼ ì•„ì¹¨ 7ì‹œ KST (UTC 22:00)
    - cron: "0 22 * * *"
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

jobs:
  send-daily-email:
    runs-on: ubuntu-latest

    steps:
      - name: Check environment variables
        run: |
          if [ -z "${{ secrets.CRON_SECRET }}" ]; then
            echo "âŒ CRON_SECRETì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
            exit 1
          fi

          if [ -z "${{ secrets.VERCEL_URL }}" ]; then
            echo "âŒ VERCEL_URLì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
            exit 1
          fi

          echo "âœ… í™˜ê²½ ë³€ìˆ˜ í™•ì¸ ì™„ë£Œ"

      - name: Send daily email with retry
        run: |
          echo "ğŸš€ ë§¤ì¼ ë©”ì¼ ì „ì†¡ ì‹œì‘..."
          echo "ğŸ“ ëŒ€ìƒ URL: ${{ secrets.VERCEL_URL }}/api/cron/send-today"
          echo "â° ì‹¤í–‰ ì‹œê°„: $(date)"

          # ì¬ì‹œë„ ë¡œì§ (ìµœëŒ€ 3íšŒ)
          max_retries=3
          retry_count=0

          while [ $retry_count -lt $max_retries ]; do
            echo "ğŸ”„ ì‹œë„ $((retry_count + 1))/$max_retries"
            
            # Vercel cron API í˜¸ì¶œ
            response=$(curl -s -w "\n%{http_code}" -X POST \
              "${{ secrets.VERCEL_URL }}/api/cron/send-today" \
              -H "Content-Type: application/json" \
              -H "x-cron-secret: ${{ secrets.CRON_SECRET }}" \
              -d '{}' \
              --max-time 30)
            
            # ì‘ë‹µ ë¶„ë¦¬
            http_code=$(echo "$response" | tail -n1)
            body=$(echo "$response" | head -n -1)
            
            echo "ğŸ“Š ì‘ë‹µ ì½”ë“œ: $http_code"
            echo "ğŸ“„ ì‘ë‹µ ë‚´ìš©: $body"
            
            # ì„±ê³µ ì—¬ë¶€ í™•ì¸
            if [ "$http_code" -eq 200 ]; then
              echo "âœ… ë©”ì¼ ì „ì†¡ ì„±ê³µ!"
              break
            else
              echo "âŒ ë©”ì¼ ì „ì†¡ ì‹¤íŒ¨ (HTTP $http_code)"
              retry_count=$((retry_count + 1))
              
              if [ $retry_count -lt $max_retries ]; then
                echo "â³ 30ì´ˆ í›„ ì¬ì‹œë„..."
                sleep 30
              else
                echo "ğŸ’¥ ìµœëŒ€ ì¬ì‹œë„ íšŸìˆ˜ ì´ˆê³¼"
                exit 1
              fi
            fi
          done
