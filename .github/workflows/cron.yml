name: Daily Email Cron Job

on:
  schedule:
    # ë§¤ì¼ ì•„ì¹¨ 7ì‹œ KST (UTC 22:00), Github Actions ì§€ì—° ê³ ë ¤ 10ë¶„ ë‹¹ê²¨ì„œ ì„¤ì •
    - cron: "50 21 * * *"
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

jobs:
  send-daily-email:
    runs-on: ubuntu-latest

    steps:
      - name: Check environment variables
        run: |
          if [ -z "${{ secrets.CRON_SECRET }}" ]; then
            echo "âŒ CRON_SECRETì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
            exit 1
          fi

          if [ -z "${{ secrets.WORKER_SECRET }}" ]; then
            echo "âŒ WORKER_SECRETì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
            exit 1
          fi

          if [ -z "${{ secrets.VERCEL_URL }}" ]; then
            echo "âŒ VERCEL_URLì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
            exit 1
          fi

          echo "âœ… í™˜ê²½ ë³€ìˆ˜ í™•ì¸ ì™„ë£Œ"

      - name: Send daily email with retry
        run: |
          echo "ğŸš€ ë§¤ì¼ ë©”ì¼ ì „ì†¡ ì‹œì‘..."
          echo "ğŸ“ ëŒ€ìƒ URL: ${{ secrets.VERCEL_URL }}/api/cron/send-today"
          echo "â° ì‹¤í–‰ ì‹œê°„: $(date)"

          echo "ğŸš€ ì¼ì¼ ë©”ì¼ ì „ì†¡ ì‘ì—…ì„ íì— ì¶”ê°€í•©ë‹ˆë‹¤..."

          # Vercel API í˜¸ì¶œ (ì‘ì—…ì„ íì— ì¶”ê°€)
          echo "ğŸ”„ íì— ì‘ì—… ì¶”ê°€ ì¤‘..."

          response=$(curl -s -w "\n%{http_code}" -X POST \
            "${{ secrets.VERCEL_URL }}/api/cron/send-today" \
            -H "Content-Type: application/json" \
            -H "x-cron-secret: ${{ secrets.CRON_SECRET }}" \
            -d '{}' \
            --max-time 60)

          # ì‘ë‹µ ë¶„ë¦¬
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | head -n -1)

          echo "ğŸ“Š ì‘ë‹µ ì½”ë“œ: $http_code"

          echo "ğŸ“„ ì‘ë‹µ ë‚´ìš©: $body"

          # ì„±ê³µ ì—¬ë¶€ í™•ì¸ (202 Accepted = íì— ì¶”ê°€ë¨)
          if [ "$http_code" -eq 202 ]; then
            echo "âœ… ì‘ì—…ì´ íì— ì„±ê³µì ìœ¼ë¡œ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!"
            echo "ğŸ“§ ì›Œì»¤ë¥¼ í˜¸ì¶œí•˜ì—¬ ì‹¤ì œ ë©”ì¼ ì „ì†¡ì„ ì‹œì‘í•©ë‹ˆë‹¤."
            
            # ì›Œì»¤ íŠ¸ë¦¬ê±° í˜¸ì¶œ
            echo "ğŸ”„ ì›Œì»¤ íŠ¸ë¦¬ê±° í˜¸ì¶œ ì¤‘..."
            
            worker_response=$(curl -s -w "\n%{http_code}" -X POST \
              "${{ secrets.VERCEL_URL }}/api/worker/trigger" \
              -H "Content-Type: application/json" \
              -H "x-worker-secret: ${{ secrets.WORKER_SECRET }}" \
              -d '{}' \
              --max-time 120)
            
            # ì›Œì»¤ ì‘ë‹µ ë¶„ë¦¬
            worker_http_code=$(echo "$worker_response" | tail -n1)
            worker_body=$(echo "$worker_response" | head -n -1)
            
            echo "ğŸ“Š ì›Œì»¤ ì‘ë‹µ ì½”ë“œ: $worker_http_code"
            
            echo "ğŸ“„ ì›Œì»¤ ì‘ë‹µ ë‚´ìš©: $worker_body"
            
            if [ "$worker_http_code" -eq 200 ]; then
              echo "âœ… ì›Œì»¤ê°€ ì„±ê³µì ìœ¼ë¡œ ì‹¤í–‰ë˜ì—ˆìŠµë‹ˆë‹¤!"
              
              # ì›Œì»¤ ì‘ë‹µì—ì„œ ì‹¤ì œ ì²˜ë¦¬ ê²°ê³¼ í™•ì¸
              worker_success=$(echo "$worker_body" | jq -r '.ok // false' 2>/dev/null || echo "false")
              worker_message=$(echo "$worker_body" | jq -r '.message // "unknown"' 2>/dev/null || echo "unknown")
              
              if [ "$worker_success" = "true" ]; then
                echo "âœ… ì›Œì»¤ ì²˜ë¦¬ ì„±ê³µ: $worker_message"
                
                # "No pending jobs" ë©”ì‹œì§€ì¸ ê²½ìš° ê²½ê³ ë§Œ ì¶œë ¥
                if echo "$worker_message" | grep -q "No pending jobs"; then
                  echo "âš ï¸  ê²½ê³ : íì— ì‘ì—…ì´ ì—†ìŠµë‹ˆë‹¤. ë‹¤ë¥¸ ì›Œì»¤ê°€ ì´ë¯¸ ì²˜ë¦¬í–ˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤."
                fi
              else
                echo "âŒ ì›Œì»¤ ì²˜ë¦¬ ì‹¤íŒ¨: $worker_message"
                exit 1
              fi
            else
              echo "âŒ ì›Œì»¤ ì‹¤í–‰ ì‹¤íŒ¨ (HTTP $worker_http_code)"
              echo "ğŸ“„ ì›Œì»¤ ì‘ë‹µ: $worker_body"
              exit 1
            fi
          else
            echo "âŒ ì‘ì—… í ì¶”ê°€ ì‹¤íŒ¨ (HTTP $http_code)"
            exit 1
          fi
