name: Admin Email Test

on:
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ë§Œ ê°€ëŠ¥
    inputs:
      admin_email:
        description: "ê´€ë¦¬ì ì´ë©”ì¼ ì£¼ì†Œ"
        required: true
        type: string
        default: "admin@example.com"

jobs:
  send-admin-test-email:
    runs-on: ubuntu-latest
    timeout-minutes: 30 # 30ë¶„ íƒ€ì„ì•„ì›ƒ ì„¤ì •

    steps:
      - name: Check environment variables
        run: |
          echo "ğŸ” í™˜ê²½ ë³€ìˆ˜ í™•ì¸ ì¤‘..."

          # í•„ìˆ˜ í™˜ê²½ ë³€ìˆ˜ ì²´í¬
          missing_vars=()

          if [ -z "${{ secrets.CRON_SECRET }}" ]; then
            missing_vars+=("CRON_SECRET")
          fi

          if [ -z "${{ secrets.VERCEL_URL }}" ]; then
            missing_vars+=("VERCEL_URL")
          fi

          # ëˆ„ë½ëœ í™˜ê²½ ë³€ìˆ˜ê°€ ìˆëŠ” ê²½ìš°
          if [ ${#missing_vars[@]} -gt 0 ]; then
            echo "âŒ ë‹¤ìŒ í™˜ê²½ ë³€ìˆ˜ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤:"
            for var in "${missing_vars[@]}"; do
              echo "   - $var"
            done
            echo "âš ï¸  GitHub Secretsì—ì„œ í™˜ê²½ ë³€ìˆ˜ë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”."
            echo "âŒ í•„ìˆ˜ í™˜ê²½ ë³€ìˆ˜ ëˆ„ë½ìœ¼ë¡œ ì‘ì—…ì„ ì¤‘ë‹¨í•©ë‹ˆë‹¤."
            exit 1  # ì—ëŸ¬ë¡œ ì²˜ë¦¬
          fi

          echo "âœ… ëª¨ë“  í•„ìˆ˜ í™˜ê²½ ë³€ìˆ˜ê°€ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤."

      - name: Send admin test email with retry
        run: |
          echo "ğŸš€ ê´€ë¦¬ì í…ŒìŠ¤íŠ¸ ë©”ì¼ ì „ì†¡ ì‹œì‘..."
          echo "ğŸ“ ëŒ€ìƒ URL: ${{ secrets.VERCEL_URL }}/api/cron/test-admin"
          echo "ğŸ“§ ê´€ë¦¬ì ì´ë©”ì¼: ${{ github.event.inputs.admin_email }}"
          echo "â° ì‹¤í–‰ ì‹œê°„: $(date)"

          # ì¬ì‹œë„ ì„¤ì •
          max_retries=3
          retry_delay=30
          success=false

          for attempt in $(seq 1 $max_retries); do
            echo "ğŸ”„ ì‹œë„ $attempt/$max_retries: ê´€ë¦¬ì í…ŒìŠ¤íŠ¸ ë©”ì¼ ì „ì†¡ ì‘ì—… ì‹¤í–‰ ì¤‘..."

            # curl ì‹¤í–‰ (íƒ€ì„ì•„ì›ƒ 10ë¶„, ì—°ê²° íƒ€ì„ì•„ì›ƒ 30ì´ˆ)
            response=$(curl -s -w "\n%{http_code}\n%{exitcode}" -X POST \
              "${{ secrets.VERCEL_URL }}/api/cron/test-admin" \
              -H "Content-Type: application/json" \
              -H "x-cron-secret: ${{ secrets.CRON_SECRET }}" \
              -d '{"admin_email": "${{ github.event.inputs.admin_email }}"}' \
              --connect-timeout 30 \
              --max-time 600 || echo -e "\n000\n28")

            # ì‘ë‹µ ë¶„ë¦¬ (body, http_code, curl_exit_code)
            body=$(echo "$response" | head -n -2)
            http_code=$(echo "$response" | tail -n 2 | head -n 1)
            curl_exit_code=$(echo "$response" | tail -n 1)

            echo "ğŸ“Š ì‘ë‹µ ì½”ë“œ: $http_code"
            echo "ï¿½ï¿½ curl ì¢…ë£Œ ì½”ë“œ: $curl_exit_code"
            echo "ğŸ“„ ì‘ë‹µ ë‚´ìš©: $body"

            # curl ì—ëŸ¬ ì²´í¬
            if [ "$curl_exit_code" != "0" ]; then
              echo "âŒ curl ì—ëŸ¬ (ì¢…ë£Œ ì½”ë“œ: $curl_exit_code)"
              
              case $curl_exit_code in
                28)
                  echo "â° íƒ€ì„ì•„ì›ƒ ì—ëŸ¬ - ì¬ì‹œë„ ì˜ˆì •"
                  ;;
                6|7)
                  echo "ğŸŒ ë„¤íŠ¸ì›Œí¬ ì—°ê²° ì—ëŸ¬ - ì¬ì‹œë„ ì˜ˆì •"
                  ;;
                *)
                  echo "ğŸ”§ ê¸°íƒ€ curl ì—ëŸ¬ - ì¬ì‹œë„ ì˜ˆì •"
                  ;;
              esac
              
              if [ $attempt -lt $max_retries ]; then
                echo "â³ ${retry_delay}ì´ˆ í›„ ì¬ì‹œë„..."
                sleep $retry_delay
                continue
              else
                echo "âŒ ìµœëŒ€ ì¬ì‹œë„ íšŸìˆ˜ ì´ˆê³¼. ì‘ì—…ì„ ê±´ë„ˆëœë‹ˆë‹¤."
                success=true  # ì‹¤íŒ¨í•´ë„ ì›Œí¬í”Œë¡œìš°ëŠ” ê³„ì† ì§„í–‰
                break
              fi
            fi

            # HTTP ì‘ë‹µ ì½”ë“œ ì²´í¬
            if [ "$http_code" = "200" ]; then
              echo "âœ… HTTP 200 ì‘ë‹µ ë°›ìŒ"
              
              # ì‘ë‹µì—ì„œ ì‹¤ì œ ì²˜ë¦¬ ê²°ê³¼ í™•ì¸ (jq ì—†ì´ë„ ë™ì‘)
              success_flag=$(echo "$body" | jq -r '.ok // false' 2>/dev/null || echo "false")
              message=$(echo "$body" | jq -r '.message // "unknown"' 2>/dev/null || echo "unknown")
              
              # jqê°€ ì—†ëŠ” ê²½ìš° ëŒ€ì²´ ë°©ë²•
              if ! command -v jq &> /dev/null; then
                echo "âš ï¸  jqê°€ ì„¤ì¹˜ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ê¸°ë³¸ê°’ì„ ì‚¬ìš©í•©ë‹ˆë‹¤."
                success_flag="true"  # ê¸°ë³¸ì ìœ¼ë¡œ ì„±ê³µìœ¼ë¡œ ê°„ì£¼
                message="jq not available"
              fi
              
              if [ "$success_flag" = "true" ]; then
                echo "âœ… ì²˜ë¦¬ ì„±ê³µ: $message"
                
                # ìƒì„¸ ìš”ì•½ ì •ë³´ ì¶œë ¥
                if echo "$body" | jq -e '.result.summary' > /dev/null 2>&1; then
                  summary=$(echo "$body" | jq -r '.result.summary')
                  echo ""
                  echo "ğŸ“ˆ ìƒì„¸ ìš”ì•½:"
                  echo "  - ë‚ ì§œ: $(echo "$summary" | jq -r '.date') ($(echo "$summary" | jq -r '.dayOfWeek')ìš”ì¼)"
                  echo "  - ì´ êµ¬ë…ì: $(echo "$summary" | jq -r '.totalSubscribers')ëª…"
                  echo "  - ì„±ê³µ: $(echo "$summary" | jq -r '.successCount')ëª…"
                  echo "  - ì‹¤íŒ¨: $(echo "$summary" | jq -r '.failureCount')ëª…"
                  echo "  - ê´€ë¦¬ì ì´ë©”ì¼: $(echo "$summary" | jq -r '.adminEmail')"
                fi
                
                success=true
                break
              else
                echo "âŒ API ì²˜ë¦¬ ì‹¤íŒ¨: $message"
                
                if [ $attempt -lt $max_retries ]; then
                  echo "â³ ${retry_delay}ì´ˆ í›„ ì¬ì‹œë„..."
                  sleep $retry_delay
                  continue
                else
                  echo "âŒ ìµœëŒ€ ì¬ì‹œë„ íšŸìˆ˜ ì´ˆê³¼. ì‘ì—…ì„ ê±´ë„ˆëœë‹ˆë‹¤."
                  success=true  # ì‹¤íŒ¨í•´ë„ ì›Œí¬í”Œë¡œìš°ëŠ” ê³„ì† ì§„í–‰
                  break
                fi
              fi
            else
              echo "âŒ HTTP ì—ëŸ¬ (ì½”ë“œ: $http_code)"
              
              if [ $attempt -lt $max_retries ]; then
                echo "â³ ${retry_delay}ì´ˆ í›„ ì¬ì‹œë„..."
                sleep $retry_delay
                continue
              else
                echo "âŒ ìµœëŒ€ ì¬ì‹œë„ íšŸìˆ˜ ì´ˆê³¼. ì‘ì—…ì„ ê±´ë„ˆëœë‹ˆë‹¤."
                success=true  # ì‹¤íŒ¨í•´ë„ ì›Œí¬í”Œë¡œìš°ëŠ” ê³„ì† ì§„í–‰
                break
              fi
            fi
          done

          if [ "$success" = "true" ]; then
            echo "âœ… ì‘ì—… ì™„ë£Œ (ì„±ê³µ ë˜ëŠ” ìµœëŒ€ ì¬ì‹œë„ í›„ ê±´ë„ˆëœ€)"
          else
            echo "âŒ ì˜ˆìƒì¹˜ ëª»í•œ ì—ëŸ¬ ë°œìƒ"
            exit 1
          fi

      - name: Test result summary
        if: always()
        run: |
          echo ""
          echo "ğŸ¯ ê´€ë¦¬ì í…ŒìŠ¤íŠ¸ ì™„ë£Œ ìš”ì•½:"
          echo "  - í…ŒìŠ¤íŠ¸ ëŒ€ìƒ: ${{ github.event.inputs.admin_email }}"
          echo "  - ì‹¤í–‰ ì‹œê°„: $(date)"
          echo "  - ì›Œí¬í”Œë¡œìš° ID: ${{ github.run_id }}"
          echo "  - ì»¤ë°‹: ${{ github.sha }}"
          echo "  - ë¸Œëœì¹˜: ${{ github.ref_name }}"
